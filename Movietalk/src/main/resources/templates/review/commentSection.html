<div xmlns:th="http://www.thymeleaf.org"
     th:fragment="commentSection(commentList, reviewId, currentUserId, reviewAuthorId)"
     class="comment-section">

    <!-- âœ¦ STYLE â€“ ë””ìì¸ë§Œ ê°œì„ , ê¸°ì¡´ êµ¬ì¡°Â·ë¡œì§ ê·¸ëŒ€ë¡œ âœ¦ -->
    <style>
        :root{
          --green:#17825e;
          --green-light:#38a169;
          --blue:#3182ce;
          --orange:#dd6b20;
          --red:#e53e3e;
          --teal:#319795;
          --radius:1rem;
          --shadow:0 10px 28px rgba(0,0,0,.06);
        }

        /* ì „ì²´ ì˜ì—­ */
        .comment-section{margin-top:2.5rem}

        /* ëŒ“ê¸€ & ëŒ€ëŒ“ê¸€ ì¹´ë“œ */
        .comment,
        .comment.reply{
          background:#fffdfc;
          backdrop-filter:saturate(180%) blur(6px);
          border-radius:var(--radius);
          box-shadow:var(--shadow);
          padding:1.2rem 1.45rem;
        }
        .comment{margin-bottom:1.4rem}
        .comment.reply{
          margin-left:2.3rem;
          background:#f8fafb;
          border-left:4px solid var(--green-light);
          margin-bottom:1.4rem;
        }

        /* í—¤ë” */
        .comment-header{
          display:flex;align-items:center;gap:.55rem;
          font-size:.83rem;color:#566
        }
        .comment-header strong{
          font-weight:700;font-size:.93rem;color:var(--green)
        }
        .comment-date{font-size:.74rem;color:#889}

        /* ë³¸ë¬¸ */
        .comment-body p{
          margin:.65rem 0;font-size:1.05rem;
          line-height:1.6;color:#222
        }

        /* ì±„íƒ ë±ƒì§€ */
        .comment-accepted{
          display:inline-block;
          background:var(--green-light);color:#fff;
          font-size:.7rem;font-weight:700;
          border-radius:.4rem;padding:.2rem .55rem;
          margin-top:.35rem
        }

        /* ì•¡ì…˜ ë²„íŠ¼ */
        .comment-actions{
          display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.6rem
        }
        .comment-actions button{
          font-size:.74rem;font-weight:600;border:none;border-radius:.5rem;
          padding:.3rem .6rem;color:#fff;cursor:pointer;
          display:inline-flex;align-items:center;gap:.2rem;
          box-shadow:0 4px 12px rgba(0,0,0,.05);
          transition:transform .1s
        }
        .comment-actions button:hover{transform:translateY(-2px)}
        .btn-like   {background:var(--green-light)}
        .btn-dislike{background:var(--red)}
        .btn-report {background:var(--orange)}
        .btn-reply  {background:var(--blue)}
        .btn-adopt  {background:var(--teal)}
        .btn-edit   {background:#ecc94b;color:#333}
        .btn-delete {background:#b83232}
        .comment-actions button[disabled]{opacity:.55;cursor:not-allowed;transform:none}

        /* ë‹µê¸€ ì…ë ¥ ë°•ìŠ¤ */
        .reply-form-container{margin-top:.7rem}
        .reply-form-container textarea{
          width:100%;border:1.8px solid #bdebd1;border-radius:.8rem;
          padding:.75rem;font-size:.96rem;background:#f9fefc;
          transition:border-color .15s
        }
        .reply-form-container textarea:focus{
          outline:none;border-color:var(--green-light)
        }
        .reply-form-container button{
          margin-top:.45rem;background:var(--green);color:#fff;border:none;
          border-radius:.7rem;padding:.45rem 1rem;font-size:.92rem;font-weight:600
        }

        /* ìƒˆ ëŒ“ê¸€ ì…ë ¥ */
        .comment-form textarea{
          width:100%;border:2px solid #d5e9d9;border-radius:.9rem;
          padding:.85rem;font-size:1.05rem;background:#f8fefa
        }
        .comment-form textarea:focus{
          outline:none;border-color:var(--green-light)
        }
        .comment-form button{
          margin-top:.6rem;background:var(--green);color:#fff;border:none;
          border-radius:.9rem;padding:.7rem 1.25rem;font-size:1.05rem;font-weight:700
        }

        /* ëª¨ë°”ì¼ */
        @media(max-width:520px){
          .comment.reply{margin-left:1.2rem}
        }
    </style>

    <h3 class="fw-bold mb-4" style="color:var(--green)">ëŒ“ê¸€</h3>

    <!-- â–½ ëŒ“ê¸€ ëª©ë¡ -->
    <div th:each="comment : ${commentList}"
         class="comment"
         th:attr="data-comment-id=${comment.id}">

        <!-- í—¤ë” -->
        <div class="comment-header">
            <strong th:text="${comment.authorName}">ì‘ì„±ì</strong>
            <span class="comment-date"
                  th:text="${#temporals.format(comment.createdAt,'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span>
        </div>

        <!-- ë³¸ë¬¸ -->
        <div class="comment-body">
            <p th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</p>
        </div>

        <!-- ì•¡ì…˜ -->
        <div class="comment-actions">
            <button class="btn-like">ğŸ‘ <span th:text="${comment.likeCnt}">0</span></button>
            <button class="btn-dislike">ğŸ‘ <span th:text="${comment.dislikeCnt}">0</span></button>
            <button class="btn-report">ğŸš¨ ì‹ ê³ </button>
            <button class="btn-reply" th:data-comment-id="${comment.id}">ğŸ’¬ ë‹µê¸€</button>

            <button class="btn-adopt"
                    th:if="${currentUserId == reviewAuthorId} and !${comment.accepted}"
                    th:data-comment-id="${comment.id}">âœ”ï¸ ì±„íƒ</button>

            <span th:if="${currentUserId == comment.authorId}">
              <button class="btn-edit"   th:data-comment-id="${comment.id}">âœï¸ ìˆ˜ì •</button>
              <button class="btn-delete" th:data-comment-id="${comment.id}">ğŸ—‘ ì‚­ì œ</button>
            </span>
        </div>

        <div th:if="${comment.accepted}" class="comment-accepted">ì±„íƒë¨</div>

        <!-- â–½ ëŒ€ëŒ“ê¸€ -->
        <div class="replies" th:if="${comment.replies}" th:each="reply : ${comment.replies}">
            <div class="comment reply" th:attr="data-comment-id=${reply.id}">
                <div class="comment-header">
                    <strong th:text="${reply.authorName}">ì‘ì„±ì</strong>
                    <span class="comment-date"
                          th:text="${#temporals.format(reply.createdAt,'yyyy-MM-dd HH:mm')}">ë‚ ì§œ</span>
                </div>

                <div class="comment-body">
                    <p th:text="${reply.content}">ëŒ€ëŒ“ê¸€ ë‚´ìš©</p>
                </div>

                <div class="comment-actions">
                    <button class="btn-like">ğŸ‘ <span th:text="${reply.likeCnt}">0</span></button>
                    <button class="btn-dislike">ğŸ‘ <span th:text="${reply.dislikeCnt}">0</span></button>
                    <button class="btn-report">ğŸš¨ ì‹ ê³ </button>

                    <button class="btn-adopt"
                            th:if="${currentUserId == reviewAuthorId} and !${reply.accepted}"
                            th:data-comment-id="${reply.id}">âœ”ï¸ ì±„íƒ</button>

                    <span th:if="${currentUserId == reply.authorId}">
                      <button class="btn-edit"   th:data-comment-id="${reply.id}">âœï¸ ìˆ˜ì •</button>
                      <button class="btn-delete" th:data-comment-id="${reply.id}">ğŸ—‘ ì‚­ì œ</button>
                    </span>
                </div>

                <div th:if="${reply.accepted}" class="comment-accepted">ì±„íƒë¨</div>
            </div><!-- /comment.reply -->
        </div><!-- /replies -->

        <!-- ë‹µê¸€ ì…ë ¥ í¼ -->
        <div class="reply-form-container"
             th:attr="data-parent-id=${comment.id}"
             style="display:none;">
            <textarea rows="2" class="reply-text" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”â€¦"></textarea>
            <button class="btn-submit-reply" type="button">ë“±ë¡</button>
        </div>
    </div><!-- /comment -->

    <!-- â–½ ìƒˆ ëŒ“ê¸€ -->
    <form class="comment-form">
        <textarea name="content" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" required></textarea>
        <button type="submit">ë“±ë¡</button>
    </form>

    <!-- reviewId / currentUserId / reviewAuthorId (ê¸°ì¡´ ê°’ ìœ ì§€) -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const reviewId       = [[${reviewId}]];
        const currentUserId  = [[${currentUserId}]];
        const reviewAuthorId = [[${reviewAuthorId}]];
        /*]]>*/
    </script>

    <!-- ê¸°ëŠ¥ ë¡œì§ (ë³€ê²½ ì—†ìŒ) -->
    <script>
        // ------- ê³µí†µ JSON ì „ì†¡ í•¨ìˆ˜ -------
        const postJson  = (url,data)=>
              fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const patchJson = (url,data)=>
              fetch(url,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});

        // ------- ëŒ“ê¸€Â·ëŒ€ëŒ“ê¸€ ì•¡ì…˜ -------
        document.querySelectorAll('.comment').forEach(el=>{
          const cid = el.dataset.commentId;

          // ì‹ ê³ 
          el.querySelector('.btn-report')?.addEventListener('click',()=>{
            const reason = prompt('ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if(!reason) return;
            postJson(`/api/comments/${cid}/reports`,{reason})
              .then(r=>r.ok?location.reload():alert('ì´ë¯¸ ì‹ ê³ í–ˆìŠµë‹ˆë‹¤.'));
          });

          // ì¢‹ì•„ìš”
          el.querySelector('.btn-like')?.addEventListener('click',()=>
            postJson(`/api/comments/${cid}/reactions`,{reactionType:'like'}).then(()=>location.reload()));

          // ì‹«ì–´ìš”
          el.querySelector('.btn-dislike')?.addEventListener('click',()=>
            postJson(`/api/comments/${cid}/reactions`,{reactionType:'dislike'}).then(()=>location.reload()));

          // ì±„íƒ
          el.querySelector('.btn-adopt')?.addEventListener('click',()=>
            postJson(`/api/comments/${cid}/adopt`,{}).then(()=>location.reload()));
        });

        // ------- ì‚­ì œ & ìˆ˜ì • (ìœ„ì„) -------
        document.querySelector('.comment-section').addEventListener('click',e=>{
          // ì‚­ì œ
          if(e.target.classList.contains('btn-delete')){
            const cid = e.target.dataset.commentId;
            if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            fetch(`/api/reviews/${reviewId}/comments/${cid}`,{method:'DELETE'})
              .then(r=>r.ok?location.reload():alert('ì‚­ì œ ì‹¤íŒ¨'));
          }

          // ìˆ˜ì •
          if(e.target.classList.contains('btn-edit')){
            const cid  = e.target.dataset.commentId;
            const text = prompt('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if(!text) return;
            patchJson(`/api/reviews/${reviewId}/comments/${cid}`,{commentId:cid,content:text})
              .then(()=>location.reload());
          }
        });

        // ------- ë‹µê¸€ í† ê¸€ -------
        document.querySelectorAll('.btn-reply').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const pid = btn.dataset.commentId;
            const box = document.querySelector(`.reply-form-container[data-parent-id="${pid}"]`);
            box.style.display = box.style.display==='none' ? 'block' : 'none';
          });
        });

        // ------- ë‹µê¸€ ë“±ë¡ -------
        document.querySelectorAll('.btn-submit-reply').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const box = btn.closest('.reply-form-container');
            const pid = box.dataset.parentId;
            const txt = box.querySelector('.reply-text').value.trim();
            if(!txt) return alert('ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
            postJson(`/api/reviews/${reviewId}/comments/${pid}/reply`,
                     {reviewId,parentId:pid,content:txt})
              .then(()=>location.reload());
          });
        });

        // ------- ìƒˆ ëŒ“ê¸€ ë“±ë¡ -------
        document.querySelector('.comment-form').addEventListener('submit',e=>{
          e.preventDefault();
          const txt = e.target.content.value.trim();
          if(!txt) return;
          postJson(`/api/reviews/${reviewId}/comments`,
                   {reviewId,parentId:null,content:txt})
            .then(r=>r.ok?(e.target.reset(),location.reload()):alert('ë“±ë¡ ì‹¤íŒ¨'));
        });
    </script>
</div>
