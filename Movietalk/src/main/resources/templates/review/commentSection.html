<div xmlns:th="http://www.thymeleaf.org"
     th:fragment="commentSection(commentList, reviewId, currentUserId, reviewAuthorId)"
     class="comment-section">

    <!-- ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
    <style>
        /* ëŒ“ê¸€ í—¤ë”: ì‘ì„±ì/ë‚ ì§œ í°íŠ¸ í¬ê¸° ì¡°ì • */
        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: #555;
        }
        .comment-header strong {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .comment-date {
            font-size: 0.65rem;
            color: #888;
        }

        /* ëŒ“ê¸€ ë³¸ë¬¸ */
        .comment-body p {
            font-size: 1rem;
            margin: 0.4rem 0;
        }

        /* accepted í‘œì‹œ */
        .comment-accepted {
            display: inline-block;
            background-color: #38a169;
            color: white;
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-top: 0.2rem;
        }

        /* ë²„íŠ¼ë“¤ í¬ê¸° ì¶”ê°€ ì¶•ì†Œ */
        .comment-actions button {
            font-size: 0.65rem;
            padding: 0.15rem 0.3rem;
            margin-right: 0.2rem;
            min-width: auto;
        }
        .comment-actions button:last-child {
            margin-right: 0;
        }

        /* ëŒ€ëŒ“ê¸€ */
        .comment.reply {
            margin-left: 2rem;
            background-color: #f9f9f9;
            padding: 0.4rem;
            border-radius: 4px;
        }

        /* ëŒ“ê¸€ ê°„ ê°„ê²© */
        .comment {
            margin-bottom: 1rem;
        }
    </style>

    <h3>ëŒ“ê¸€</h3>

    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <div th:each="comment : ${commentList}"
         class="comment"
         th:attr="data-comment-id=${comment.id}">
        <!-- ê¸°ë³¸ ëŒ“ê¸€ -->
        <div class="comment-header">
            <strong th:text="${comment.authorName}">ì‘ì„±ì</strong>
            <span th:text="${#temporals.format(comment.createdAt,'yyyy-MM-dd HH:mm')}"
                  class="comment-date">ì‘ì„±ì¼</span>
        </div>
        <div class="comment-body">
            <p th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</p>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
        <div class="comment-actions">
            <button type="button" class="btn-like">ğŸ‘ <span th:text="${comment.likeCnt}">0</span></button>
            <button type="button" class="btn-dislike">ğŸ‘ <span th:text="${comment.dislikeCnt}">0</span></button>
            <button type="button" class="btn-report">ğŸš¨ ì‹ ê³ </button>

            <!-- ë‹µê¸€ ë²„íŠ¼ -->
            <button type="button" class="btn-reply" th:data-comment-id="${comment.id}">ğŸ’¬ ë‹µê¸€</button>

            <!-- ì±„íƒ ë²„íŠ¼ -->
            <button type="button" class="btn-adopt"
                    th:if="${currentUserId == reviewAuthorId} and !${comment.accepted}"
                    th:data-comment-id="${comment.id}">âœ”ï¸ ì±„íƒ</button>

            <!-- ìˆ˜ì •/ì‚­ì œ -->
            <span th:if="${currentUserId == comment.authorId}">
                <button type="button" class="btn-edit" th:data-comment-id="${comment.id}">âœï¸ ìˆ˜ì •</button>
                <button type="button" class="btn-delete" th:data-comment-id="${comment.id}">ğŸ—‘ï¸ ì‚­ì œ</button>
            </span>
        </div>

        <!-- ì±„íƒë¨ í‘œì‹œ -->
        <div th:if="${comment.accepted}" class="comment-accepted">ì±„íƒë¨</div>

        <!-- ëŒ€ëŒ“ê¸€ ëª©ë¡ -->
        <div class="replies" th:if="${comment.replies}" th:each="reply : ${comment.replies}">
            <div class="comment reply" th:attr="data-comment-id=${reply.id}">
                <div class="comment-header">
                    <strong th:text="${reply.authorName}"></strong>
                    <span th:text="${#temporals.format(reply.createdAt,'yyyy-MM-dd HH:mm')}" class="comment-date"></span>
                </div>
                <div class="comment-body">
                    <p th:text="${reply.content}"></p>
                </div>
                <div class="comment-actions">
                    <button type="button" class="btn-like">ğŸ‘ <span th:text="${reply.likeCnt}">0</span></button>
                    <button type="button" class="btn-dislike">ğŸ‘ <span th:text="${reply.dislikeCnt}">0</span></button>
                    <button type="button" class="btn-report">ğŸš¨ ì‹ ê³ </button>

                    <!-- ì±„íƒ / ìˆ˜ì • / ì‚­ì œë§Œ -->
                    <button type="button" class="btn-adopt"
                            th:if="${currentUserId == reviewAuthorId} and !${reply.accepted}"
                            th:data-comment-id="${reply.id}">âœ”ï¸ ì±„íƒ</button>
                    <span th:if="${currentUserId == reply.authorId}">
                        <button type="button" class="btn-edit" th:data-comment-id="${reply.id}">âœï¸ ìˆ˜ì •</button>
                        <button type="button" class="btn-delete" th:data-comment-id="${reply.id}">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </span>
                </div>
                <div th:if="${reply.accepted}" class="comment-accepted">ì±„íƒë¨</div>
            </div>
        </div>

        <!-- ë‹µê¸€ ì…ë ¥ í¼ (ìˆ¨ê¹€) -->
        <div class="reply-form-container"
             th:attr="data-parent-id=${comment.id}"
             style="display:none;">
            <textarea rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" class="reply-text"></textarea>
            <button type="button" class="btn-submit-reply">ë“±ë¡</button>
        </div>
    </div>

    <!-- ìƒˆ ëŒ“ê¸€ ì‘ì„± í¼ -->
    <form class="comment-form">
        <textarea name="content" rows="2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
        <button type="submit">ë“±ë¡</button>
    </form>

    <!-- JS: reviewId, currentUserId, reviewAuthorId -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const reviewId       = [[${reviewId}]];
        const currentUserId  = [[${currentUserId}]];
        const reviewAuthorId = [[${reviewAuthorId}]];
        /*]]>*/
    </script>

    <script>
        // ê³µí†µ JSON ì „ì†¡ í•¨ìˆ˜ (POST)
        function postJson(url, data) {
            return fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        // ìˆ˜ì • ì „ìš© JSON ì „ì†¡ í•¨ìˆ˜ (PATCH)
        function patchJson(url, data) {
            return fetch(url, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        // ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.querySelectorAll('.comment').forEach(el => {
            const cid = el.dataset.commentId;

            // ì‹ ê³  ë²„íŠ¼
            el.querySelector('.btn-report')?.addEventListener('click', () => {
                const reason = prompt('ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                if (!reason) return;
                postJson(`/api/comments/${cid}/reports`, { reason })
                    .then(res => res.ok ? location.reload() : res.text().then(msg => alert(msg)));
            });

            // ì¢‹ì•„ìš” / ì‹«ì–´ìš” / ì±„íƒ
            el.querySelector('.btn-like')?.addEventListener('click', () =>
                postJson(`/api/comments/${cid}/reactions`, { reactionType: 'like' }).then(() => location.reload())
            );
            el.querySelector('.btn-dislike')?.addEventListener('click', () =>
                postJson(`/api/comments/${cid}/reactions`, { reactionType: 'dislike' }).then(() => location.reload())
            );
            el.querySelector('.btn-adopt')?.addEventListener('click', () =>
                postJson(`/api/comments/${cid}/adopt`, {}).then(() => location.reload())
            );

            // ìˆ˜ì • ë²„íŠ¼ (PATCH)
            el.querySelector('.btn-edit')?.addEventListener('click', () => {
                const text = prompt('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:');
                if (!text) return;
                patchJson(
                    `/api/reviews/${reviewId}/comments/${cid}`,
                    { commentId: cid, content: text }
                ).then(() => location.reload());
            });

            // ì‚­ì œ ë²„íŠ¼
            el.querySelector('.btn-delete')?.addEventListener('click', () => {
                if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                fetch(`/api/reviews/${reviewId}/comments/${cid}`, { method: 'DELETE' })
                    .then(r => r.ok ? location.reload() : alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
            });
        });

        // ë‹µê¸€ í† ê¸€ ë° ì „ì†¡ (ìµœìƒìœ„ ëŒ“ê¸€ë§Œ)
        document.querySelectorAll('.btn-reply').forEach(btn => {
            btn.addEventListener('click', () => {
                const pid = btn.dataset.commentId;
                const form = document.querySelector(`.reply-form-container[data-parent-id="${pid}"]`);
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            });
        });
        document.querySelectorAll('.btn-submit-reply').forEach(btn => {
            btn.addEventListener('click', () => {
                const container = btn.closest('.reply-form-container');
                const text = container.querySelector('.reply-text').value.trim();
                if (!text) return alert('ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
                const pid = container.dataset.parentId;
                postJson(`/api/reviews/${reviewId}/comments/${pid}/reply`, { reviewId, parentId: pid, content: text })
                    .then(() => location.reload());
            });
        });

        // ìƒˆ ëŒ“ê¸€ ë“±ë¡
        document.querySelector('.comment-form').addEventListener('submit', e => {
            e.preventDefault();
            const txt = e.target.querySelector('textarea[name="content"]').value.trim();
            if (!txt) return;
            postJson(`/api/reviews/${reviewId}/comments`, { reviewId, parentId: null, content: txt })
                .then(res => res.ok ? e.target.reset() : Promise.reject())
                .then(() => location.reload())
                .catch(() => alert('ë“±ë¡ ì‹¤íŒ¨'));
        });
    </script>
</div>
