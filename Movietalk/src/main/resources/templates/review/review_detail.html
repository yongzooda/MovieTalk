<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
  <meta charset="UTF-8" />
  <title>ë¦¬ë·° ìƒì„¸ | MovieTalk</title>
  <!-- CSRF íˆë“  í•„ë“œ ìë™ ìƒì„± -->
  <sec:csrfInput />

  <style>
    /* ê¸°ì¡´ CSS ìœ ì§€ */
    body { font-family: 'Segoe UI', sans-serif; background-color: #f7f9f9; margin: 0; padding: 2rem; }
    .container { max-width: 900px; margin: auto; }
    .movie-info { display: flex; align-items: flex-start; background-color: white; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
    .poster { width: 150px; height: auto; border-radius: 8px; margin-right: 1rem; }
    .movie-meta h2 { margin: 0 0 0.5rem; color: #2f855a; }
    .movie-meta p { margin: 0.2rem 0; color: #4a5568; }
    .review-content { background-color: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .review-actions { display: flex; gap: 1rem; margin-top: 1rem; }
    .action-btn { background-color: #68d391; border: none; padding: 0.5rem 1rem; border-radius: 6px; color: white; cursor: pointer; }
    .action-btn:hover { background-color: #48bb78; }
    .comment-section { background-color: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-top: 1.5rem; }
  </style>
</head>
<body>
<div class="container">
  <!-- ì˜í™” ì •ë³´ + í¬ìŠ¤í„° -->
  <div class="movie-info">
    <img th:src="${review.moviePosterUrl}" alt="í¬ìŠ¤í„°" class="poster" />
    <div class="movie-meta">
      <h2 th:text="${review.movieTitle}">ì˜í™” ì œëª©</h2>
      <p th:text="'ì‘ì„±ì: ' + ${review.author}">ì‘ì„±ì</p>
      <p th:text="'ì‘ì„±ì¼: ' + ${#temporals.format(review.createdAt,'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</p>
    </div>
  </div>

  <!-- ë¦¬ë·° ë‚´ìš© -->
  <div class="review-content" th:text="${review.content}">ë¦¬ë·° ë³¸ë¬¸</div>

  <!-- ì¢‹ì•„ìš” / ì‹«ì–´ìš” / ì‹ ê³  -->
  <div class="review-actions">
    <button class="action-btn" data-action="like">
      ğŸ‘ ì¢‹ì•„ìš” (<span id="likeCount" th:text="${review.likeCount}">0</span>)
    </button>
    <button class="action-btn" data-action="dislike">
      ğŸ‘ ì‹«ì–´ìš” (<span id="dislikeCount" th:text="${review.dislikeCount}">0</span>)
    </button>
    <button class="action-btn" id="reportReviewBtn">ğŸš¨ ì‹ ê³ </button>
  </div>

  <!-- ëŒ“ê¸€ ì„¹ì…˜(fragment) ì‚½ì…: reviewId, reviewAuthorId ì¶”ê°€ ì „ë‹¬ -->
  <div th:replace="~{review/commentSection :: commentSection(
                        ${commentList},
                        ${review.id},
                        ${review.userId}
                      )}"
       class="comment-section"></div>
</div>

<!-- JavaScript -->
<script th:inline="javascript">
  /*<![CDATA[*/
  document.addEventListener('DOMContentLoaded', () => {
    const reviewId   = /*[[${review.id}]]*/ 0;
    const csrfToken  = document.querySelector('input[name="_csrf"]').value;
    const csrfHeader = document.querySelector('input[name="_csrf_header"]').value;

    async function postJson(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          [csrfHeader]: csrfToken
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨: ' + res.status);
      return res;
    }

    // ë¦¬ë·° ì¢‹ì•„ìš”/ì‹«ì–´ìš”
    document.querySelectorAll('.review-actions [data-action]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        await postJson(`/api/reviews/${reviewId}/reactions`, { reactionType: action });
        const span = document.getElementById(action + 'Count');
        span.textContent = parseInt(span.textContent) + 1;
      });
    });

    // ë¦¬ë·° ì‹ ê³ 
    document.getElementById('reportReviewBtn').addEventListener('click', async () => {
      const reason = prompt('ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!reason) return;
      await postJson(`/api/reviews/${reviewId}/reports`, { reason });
      alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤');
    });

    // ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš”
    document.querySelectorAll('.comment-actions [data-action]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const cid = btn.closest('.comment').dataset.commentId;
        const action = btn.dataset.action;
        await postJson(`/api/comments/${cid}/reactions`, { reactionType: action });
        const span = btn.querySelector(`.${action}Count`);
        span.textContent = parseInt(span.textContent) + 1;
      });
    });

    // ëŒ“ê¸€ ì‹ ê³ 
    document.querySelectorAll('.report-comment-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const cid    = btn.closest('.comment').dataset.commentId;
        const reason = prompt('ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (!reason) return;
        await postJson(`/api/comments/${cid}/reports`, { reason });
        alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤');
      });
    });

    // ëŒ“ê¸€ ì±„íƒ (ë¦¬ë·° ì‘ì„±ì ì „ìš©)
    document.querySelectorAll('.adopt-comment-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const cid = btn.closest('.comment').dataset.commentId;
        await postJson(`/api/comments/${cid}/adopt`, {});
        // ì±„íƒë¨ ë ˆì´ë¸”ë¡œ êµì²´
        const done = document.createElement('button');
        done.className = 'action-btn adopted-label';
        done.disabled = true;
        done.textContent = 'âœ”ï¸ ì±„íƒë¨';
        btn.replaceWith(done);
      });
    });
  });
  /*]]>*/
</script>
</body>
</html>
