<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¦¬ë·° ìƒì„¸ | MovieTalk</title>

  <!-- Pretendard -->
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap"
        rel="stylesheet">

  <style>
    :root{
      --green:#17825e;--green-light:#38a169;
      --blue:#3182ce;--red:#e53e3e;--orange:#ed8936;
      --radius:1.4rem;--shadow:0 16px 42px rgba(0,0,0,.07);
    }

    /* â”€â”€â”€â”€â”€ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€ */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;
      background:linear-gradient(135deg,#f7fbfe 0%,#eff3f6 80%);
      color:#1d1f23;line-height:1.6;
      /* ìƒˆ ë„¤ë¹„(60px) + ì—¬ìœ  */
      padding-top:80px;
    }
    a{color:inherit;text-decoration:none}

    .container{
      max-width:960px;margin:0 auto;padding:2.4rem 1.6rem;
      background:#ffffffee;backdrop-filter:saturate(180%) blur(8px);
      border-radius:var(--radius);box-shadow:var(--shadow);
      animation:fadePop .45s ease;
    }
    @keyframes fadePop{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:none}}

    /* â”€â”€â”€â”€â”€ ì˜í™” ì¹´ë“œ â”€â”€â”€â”€â”€ */
    .movie-info-card{
      display:flex;gap:2rem;align-items:flex-start;
      background:#fff;border-radius:1.2rem;box-shadow:0 6px 24px rgba(0,0,0,.06);
      padding:2rem 2.2rem;margin-bottom:2.2rem;
    }
    .poster{
      width:180px;min-width:130px;border-radius:1rem;object-fit:cover;
      box-shadow:0 4px 18px rgba(0,0,0,.08);transition:transform .18s,box-shadow .18s;
    }
    .poster:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .movie-meta h2{font-size:2rem;font-weight:700;color:var(--green);margin-bottom:.6rem}
    .meta-list{font-size:1.05rem;color:#444;margin-bottom:1.1rem}
    .meta-list b{margin-right:.2rem}
    .movie-overview{
      background:#f5f7fa;border-radius:.8rem;padding:1rem;margin:1.1rem 0;color:#333
    }
    .movie-cast{font-size:1.02rem;color:#556;margin-bottom:.4rem}

    /* â”€â”€â”€â”€â”€ ë³„ì  í‘œì‹œ â”€â”€â”€â”€â”€ */
    .review-rating{display:flex;align-items:center;gap:4px;font-size:1.45rem;margin:.8rem 0}
    .review-rating .star svg{width:26px;height:26px;vertical-align:middle}
    .rating-number{margin-left:8px;font-weight:700;color:var(--green-light)}

    /* â”€â”€â”€â”€â”€ ë³¸ë¬¸ â”€â”€â”€â”€â”€ */
    .review-content{
      background:#fff;border-radius:1.1rem;padding:1.6rem;
      box-shadow:0 5px 18px rgba(0,0,0,.05);font-size:1.12rem;line-height:1.6;
      margin-bottom:2rem
    }

    /* â”€â”€â”€â”€â”€ ë²„íŠ¼ â”€â”€â”€â”€â”€ */
    .button-group{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1.7rem}
    .action-btn{
      display:inline-flex;align-items:center;gap:.25rem;
      font-weight:600;font-size:.96rem;padding:.4rem .8rem;border-radius:.7rem;border:none;cursor:pointer;color:#fff;
      box-shadow:0 3px 12px rgba(0,0,0,.06);transition:transform .12s,box-shadow .12s;
    }
    .action-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.12)}
    .like   {background:var(--green-light)}
    .dislike{background:var(--red)}
    .report {background:var(--orange)}
    .edit   {background:#ecc94b;color:#333}
    .delete {background:var(--red)}
    .back   {background:var(--blue)}
    .action-btn[disabled]{opacity:.55;cursor:not-allowed;transform:none}

    /* â”€â”€â”€â”€â”€ ëª¨ë‹¬ â”€â”€â”€â”€â”€ */
    .modal{position:fixed;inset:0;display:none;justify-content:center;align-items:center;
           background:rgba(0,0,0,.55);z-index:99}
    .modal-content{
      background:#fff;border-radius:1rem;padding:1.6rem;width:90%;max-width:380px;
      box-shadow:0 16px 40px rgba(0,0,0,.2);animation:fadeScale .25s ease}
    @keyframes fadeScale{0%{opacity:0;transform:scale(.9)}100%{opacity:1}}
    .close-btn{float:right;font-size:1.3rem;cursor:pointer;color:#666;margin-top:-.3rem}

    .modal textarea{width:100%;height:90px;font-size:1rem;padding:.7rem;border-radius:.7rem;
                    border:1.6px solid #cfdede;margin-bottom:.7rem}

    /* â”€â”€â”€â”€â”€ ê¸°íƒ€ â”€â”€â”€â”€â”€ */
    .flash-error{
      background:#fff7f7;color:#c53030;padding:.8rem 1rem;border-radius:.8rem;margin-bottom:1.2rem
    }

    /* ëª¨ë°”ì¼ */
    @media(max-width:700px){
      .movie-info-card{flex-direction:column;align-items:center;padding:1.4rem}
      .poster{margin-bottom:1.4rem;width:60vw;max-width:240px}
      .movie-meta h2{font-size:1.6rem;text-align:center}
    }
  </style>
</head>

<body>

<!-- ğŸ§­ ìƒˆ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ -->
<div th:replace="~{fragments/top-nav :: topNav}"></div>

<div class="container">
  <!-- ë’¤ë¡œê°€ê¸° -->
  <a th:href="@{/reviews}" class="action-btn back mb-3">â† ë¦¬ë·° ëª©ë¡</a>

  <!-- ì‹ ê³  ì˜¤ë¥˜ -->
  <div th:if="${reportError}" class="flash-error">
    <p th:text="${reportError}">ì´ë¯¸ ì‹ ê³ í•œ ë¦¬ë·°ì…ë‹ˆë‹¤.</p>
  </div>

  <!-- â”€â”€ ì˜í™” ì •ë³´ â”€â”€ -->
  <div class="movie-info-card">
    <img th:src="${review.moviePosterUrl}" alt="poster" class="poster">
    <div class="movie-meta">
      <h2 th:text="${review.movieTitle}">ì˜í™” ì œëª©</h2>

      <div class="meta-list">
        <div><b>ê°œë´‰ì¼</b> <span th:text="${movie.releaseDate}">-</span></div>
        <div><b>ëŸ¬ë‹íƒ€ì„</b> <span th:text="${movie.runtime}">0</span>ë¶„</div>
        <div><b>ì¥ë¥´</b>
          <span th:each="g,stat:${movie.genres}">
            <span th:text="${g.name}">ì¥ë¥´</span><span th:if="${!stat.last}">, </span>
          </span>
        </div>
        <div><b>êµ­ê°€</b>
          <span th:each="c,stat:${movie.productionCountries}">
            <span th:text="${c.name}">êµ­ê°€</span><span th:if="${!stat.last}">, </span>
          </span>
        </div>
      </div>

      <div class="movie-overview" th:if="${movie.overview}" th:text="${movie.overview}"></div>

      <div class="movie-cast">
        <b>ì¶œì—°ì§„</b>
        <span th:each="c,stat:${movie.cast}">
          <span th:if="${stat.index < 8}" th:text="${c.name}"></span>
          <span th:if="${stat.index < 7 && stat.index < movie.cast.size()-1}">, </span>
        </span>
        <span th:if="${movie.cast.size()>8}">
          â€¦(<span th:text="${movie.cast.size()-8}">0</span>ëª… ë”)
        </span>
      </div>

      <p class="mt-2 mb-1" th:text="'ì‘ì„±ì : '+${review.author}"></p>
      <p class="mb-0" th:text="'ì‘ì„±ì¼ : '+${#temporals.format(review.createdAt,'yyyy-MM-dd HH:mm')}"></p>
    </div>
  </div>

  <!-- â”€â”€ ë³„ì  â”€â”€ -->
  <div class="review-rating" th:if="${review.rating != null}">
    <span class="star" th:each="i:${#numbers.sequence(1,5)}" th:with="v=${i},r=${review.rating}">
      <span th:if="${r>=v}">
        <svg viewBox="0 0 24 24"><path fill="#fcd34d" d="M12 17.8l-6.7 3.7 1.6-7.1L2 9.2l7.2-.6L12 2.5l2.8 6.1 7.2.6-4.9 5.2 1.6 7.1z"/></svg>
      </span>
      <span th:if="${r>=v-0.5 && r<v}">
        <svg viewBox="0 0 24 24">
          <defs><linearGradient id="halfGrad[[${i}]]" x1="0" x2="1"><stop offset="50%" stop-color="#fcd34d"/><stop offset="50%" stop-color="#d3e7da"/></linearGradient></defs>
          <path fill="url(#halfGrad[[${i}]])" d="M12 17.8l-6.7 3.7 1.6-7.1L2 9.2l7.2-.6L12 2.5l2.8 6.1 7.2.6-4.9 5.2 1.6 7.1z"/>
        </svg>
      </span>
      <span th:if="${r<v-0.5}">
        <svg viewBox="0 0 24 24"><path fill="#d3e7da" d="M12 17.8l-6.7 3.7 1.6-7.1L2 9.2l7.2-.6L12 2.5l2.8 6.1 7.2.6-4.9 5.2 1.6 7.1z"/></svg>
      </span>
    </span>
    <span class="rating-number" th:text="${review.rating}">0</span>
  </div>

  <!-- â”€â”€ ë³¸ë¬¸ â”€â”€ -->
  <div class="review-content" th:text="${review.content}">ë¦¬ë·° ë³¸ë¬¸</div>

  <!-- â”€â”€ ë²„íŠ¼ â”€â”€ -->
  <div class="button-group">
    <form th:action="@{/reviews/{id}/reactions(id=${review.id})}" method="post">
      <input type="hidden" name="reactionType" value="like">
      <button class="action-btn like"
              th:disabled="${userReaction != null and userReaction.equals(T(com.sec.movietalk.common.domain.review.ReviewReactions.ReactionType).dislike)}">
        ğŸ‘ ì¢‹ì•„ìš” (<span th:text="${review.likeCount}">0</span>)
      </button>
    </form>

    <form th:action="@{/reviews/{id}/reactions(id=${review.id})}" method="post">
      <input type="hidden" name="reactionType" value="dislike">
      <button class="action-btn dislike"
              th:disabled="${userReaction != null and userReaction.equals(T(com.sec.movietalk.common.domain.review.ReviewReactions.ReactionType).like)}">
        ğŸ‘ ì‹«ì–´ìš” (<span th:text="${review.dislikeCount}">0</span>)
      </button>
    </form>

    <button id="openReportModal" class="action-btn report">ğŸš¨ ì‹ ê³ </button>

    <!-- ìˆ˜ì •/ì‚­ì œ(ì‘ì„±ì) -->
    <th:block th:if="${currentUserId != null and currentUserId == reviewAuthorId}">
      <a class="action-btn edit" th:href="@{/reviews/edit/{id}(id=${review.id})}">âœï¸ ìˆ˜ì •</a>
      <form th:action="@{/reviews/delete/{reviewId}(reviewId=${review.id})}"
            method="post" style="display:inline;"
            onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
        <button class="action-btn delete">ğŸ—‘ ì‚­ì œ</button>
      </form>
    </th:block>
  </div>

  <!-- â”€â”€ ì‹ ê³  ëª¨ë‹¬ â”€â”€ -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close-btn">&times;</span>
      <form th:action="@{/reviews/{id}/reports(id=${review.id})}" method="post">
        <textarea name="reason" placeholder="ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <button class="action-btn report w-100" type="submit">ğŸš¨ ì œì¶œ</button>
      </form>
    </div>
  </div>

  <!-- ëŒ“ê¸€ -->
  <div th:replace="~{review/commentSection :: commentSection(
                    ${commentList}, ${review.id}, ${currentUserId}, ${reviewAuthorId})}"
       class="comment-section mt-4"></div>
</div>

<!-- ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  const modal=document.getElementById('reportModal');
  document.getElementById('openReportModal').onclick=()=>modal.style.display='flex';
  document.getElementById('closeModal').onclick =()=>modal.style.display='none';
  window.onclick=e=>{ if(e.target===modal) modal.style.display='none'; };
</script>
</body>
</html>
